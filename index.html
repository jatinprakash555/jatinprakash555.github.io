<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive TCC Algorithm Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <!-- 
        APPLICATION STRUCTURE & DESIGN NOTES:
        - This is a Single Page Application (SPA) built with vanilla JavaScript, HTML, and Tailwind CSS.
        - Dark Mode: Implemented using Tailwind's 'dark' variant, controlled by a class on the <html> element. The theme state is persisted in localStorage. All components, including Chart.js charts and the Three.js canvas, are theme-aware.
        - Modularity: The JavaScript is organized into logical sections (THEME, UI, CHARTS, GLOBE, etc.) within a single DOMContentLoaded listener for clarity and maintainability. A global 'state' object manages the application's theme, chart instances, and data.
        - Components: Each major section of the report (Methodology, Globe, Dashboard) is a self-contained <section> element. Interactive components like charts and the 3D globe are initialized and managed by dedicated functions.
        - Responsiveness: The layout uses Tailwind's responsive prefixes to ensure a seamless experience on all screen sizes, from mobile to desktop.
        - User Experience: A loading overlay provides feedback during initial setup and data updates. A custom modal replaces browser alerts for a more integrated feel.
        - OPTIMIZATION: The globe now uses an adaptive Level of Detail (LOD) strategy. It loads a low-polygon sphere first for speed, then upgrades to a high-polygon sphere on capable devices.
    -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        // NOTE: To enable Firebase persistence, you must provide your own Firebase project configuration here.
        const firebaseConfig = {}; // Intentionally empty for this example

        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        
        try {
            // Check if firebaseConfig has been populated
            if (Object.keys(firebaseConfig).length > 0) {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Firebase: User signed in:", window.userId);
                    } else {
                        console.log("Firebase: No user signed in. Attempting anonymous sign-in.");
                        try {
                            await signInAnonymously(window.auth);
                            window.userId = window.auth.currentUser?.uid;
                        } catch (error) {
                            console.error("Firebase: Anonymous sign-in failed:", error);
                            window.userId = crypto.randomUUID(); // Fallback for local operation
                        }
                    }
                    // Notify the main script that Firebase is ready
                    document.dispatchEvent(new CustomEvent('firebaseReady'));
                });
            } else {
                throw new Error("Firebase config is empty.");
            }
        } catch (error) {
            console.warn("Firebase not configured. Running in local mode.", error.message);
            window.userId = crypto.randomUUID();
            // Dispatch the event anyway so the app can start in local mode
            setTimeout(() => document.dispatchEvent(new CustomEvent('firebaseReady')), 10);
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for active states, transitions, and complex components */
        .step-card.active {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .tab-button.active {
            border-bottom-width: 3px;
        }
        #globeCanvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #globeCanvas:active {
            cursor: grabbing;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* Hide scrollbar for the body but allow scrolling */
        html {
            scrollbar-width: none; /* For Firefox */
        }
        body::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, and Opera */
        }
    </style>
</head>
<body class="bg-sky-50 text-sky-900 dark:bg-slate-900 dark:text-sky-200 antialiased transition-colors duration-300">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/80 dark:bg-black/80 z-[100] flex flex-col items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="spinner h-16 w-16 rounded-full border-4 border-t-sky-500 border-gray-200 dark:border-gray-600 dark:border-t-sky-500"></div>
        <p id="loadingMessage" class="mt-4 text-lg font-semibold text-sky-800 dark:text-sky-300">Initializing...</p>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black/50 z-[110] flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full text-center transform scale-95 transition-transform duration-300">
            <p id="modalMessage" class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-6">Are you sure?</p>
            <div class="flex justify-center gap-4">
                <button id="modalConfirmBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105">Confirm</button>
                <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-white font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm sticky top-0 z-50 shadow-md">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="text-2xl font-bold text-sky-700 dark:text-sky-400">üõ∞Ô∏è TCC Explorer</div>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#overview" class="text-gray-600 hover:text-sky-600 dark:text-gray-300 dark:hover:text-sky-400 transition">Overview</a>
                <a href="#methodology" class="text-gray-600 hover:text-sky-600 dark:text-gray-300 dark:hover:text-sky-400 transition">Methodology</a>
                <a href="#globe-view" class="text-gray-600 hover:text-sky-600 dark:text-gray-300 dark:hover:text-sky-400 transition">Global View</a>
                <a href="#cluster-dashboard" class="text-gray-600 hover:text-sky-600 dark:text-gray-300 dark:hover:text-sky-400 transition">Dashboard</a>
                <a href="#outcomes" class="text-gray-600 hover:text-sky-600 dark:text-gray-300 dark:hover:text-sky-400 transition">Outcomes</a>
                <a href="#llm-qa" class="text-gray-600 hover:text-sky-600 dark:text-gray-300 dark:hover:text-sky-400 transition">AI Q&A</a>
            </div>
            <!-- Theme Toggle & Mobile Nav -->
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="text-xl text-gray-500 dark:text-gray-400 hover:text-sky-600 dark:hover:text-sky-400" aria-label="Toggle theme">
                    <i class="fas fa-sun" id="theme-toggle-light-icon"></i>
                    <i class="fas fa-moon hidden" id="theme-toggle-dark-icon"></i>
                </button>
                <div class="md:hidden">
                    <select id="mobile-nav" class="bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-md p-2 text-gray-700 dark:text-gray-300">
                        <option value="#overview">Overview</option>
                        <option value="#methodology">Methodology</option>
                        <option value="#globe-view">Global View</option>
                        <option value="#cluster-dashboard">Dashboard</option>
                        <option value="#outcomes">Outcomes</option>
                        <option value="#llm-qa">AI Q&A</option>
                    </select>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12 space-y-20">

        <!-- Section: Overview -->
        <section id="overview" class="text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold text-sky-800 dark:text-sky-300 mb-4">AI-Powered Tropical Cloud Cluster Explorer</h1>
            <p class="max-w-3xl mx-auto text-lg text-sky-700 dark:text-sky-400">
                An interactive exploration of an AI/ML algorithm designed to detect, characterize, and track Tropical Cloud Clusters (TCCs) from satellite data, a critical task for weather and climate analysis.
            </p>
        </section>

        <!-- Section: Interactive Methodology -->
        <section id="methodology">
            <h2 class="text-3xl font-bold text-center mb-2 text-sky-800 dark:text-sky-300">The Algorithm Unpacked</h2>
            <p class="text-center text-lg text-sky-700 dark:text-sky-400 mb-10">Click on each step to see the details of the TCC identification process.</p>
            <div class="flex flex-col md:flex-row justify-center items-start gap-8">
                <div class="w-full md:w-1/3 grid grid-cols-2 md:grid-cols-1 gap-4">
                    <div data-step="1" class="step-card cursor-pointer border-2 bg-white dark:bg-slate-800 p-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300">
                        <h3 class="font-bold text-sky-600 dark:text-sky-400">1. Data Ingestion</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Loading satellite data.</p>
                    </div>
                    <div data-step="2" class="step-card cursor-pointer border-2 bg-white dark:bg-slate-800 p-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300">
                        <h3 class="font-bold text-sky-600 dark:text-sky-400">2. Candidate ID</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Filtering by size & intensity.</p>
                    </div>
                    <div data-step="3" class="step-card cursor-pointer border-2 bg-white dark:bg-slate-800 p-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300">
                        <h3 class="font-bold text-sky-600 dark:text-sky-400">3. Independence</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Grouping parent clusters.</p>
                    </div>
                     <div data-step="4" class="step-card cursor-pointer border-2 bg-white dark:bg-slate-800 p-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300">
                        <h3 class="font-bold text-sky-600 dark:text-sky-400">4. Tracking</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Following TCC movement.</p>
                    </div>
                </div>
                <div id="step-content-container" class="w-full md:w-1/2 bg-white dark:bg-slate-800 p-8 rounded-lg shadow-2xl min-h-[280px]">
                    <!-- JS will populate this -->
                </div>
            </div>
        </section>

        <!-- Section: Global TCC View -->
        <section id="globe-view">
            <h2 class="text-3xl font-bold text-center mb-2 text-sky-800 dark:text-sky-300">Global TCC View</h2>
            <p class="text-center text-lg text-sky-700 dark:text-sky-400 mb-6">Explore simulated TCCs on an interactive globe. Data updates automatically.</p>
            <div class="relative w-full max-w-4xl mx-auto aspect-video bg-sky-100 dark:bg-slate-800 rounded-2xl shadow-2xl border border-blue-200 dark:border-slate-700 overflow-hidden">
                <canvas id="globeCanvas"></canvas>
                <div class="absolute top-4 left-4 right-4 flex justify-between items-start pointer-events-none">
                    <button id="resetGlobeBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-transform transform hover:scale-105 pointer-events-auto">
                        Reset View
                    </button>
                    <div class="bg-white/70 dark:bg-slate-800/70 p-2 rounded-lg text-center pointer-events-auto">
                        <p class="text-sm font-semibold">Lat: <span id="current-latitude">0.00</span>¬∞</p>
                        <p class="text-sm font-semibold">Lon: <span id="current-longitude">0.00</span>¬∞</p>
                    </div>
                </div>
            </div>
             <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-6">
                <div class="flex flex-wrap justify-center gap-2">
                    <button data-mode="visible" class="globe-mode-btn font-semibold py-2 px-4 rounded-full text-sm transition">Visible</button>
                    <button data-mode="infrared" class="globe-mode-btn font-semibold py-2 px-4 rounded-full text-sm transition">Infrared</button>
                    <button data-mode="water-vapor" class="globe-mode-btn font-semibold py-2 px-4 rounded-full text-sm transition">Water Vapor</button>
                    <button data-mode="cloud-clusters" class="globe-mode-btn font-semibold py-2 px-4 rounded-full text-sm transition">Clusters</button>
                </div>
                <button id="clearDataBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-transform transform hover:scale-105">
                    Clear History
                </button>
            </div>
            <p class="text-center text-sm text-gray-500 mt-4">Last Updated: <span id="last-updated"></span></p>
        </section>

        <!-- Section: Identified Clusters Dashboard -->
        <section id="cluster-dashboard">
            <h2 class="text-3xl font-bold text-center mb-2 text-sky-800 dark:text-sky-300">TCC Analysis Dashboard</h2>
            <p class="text-center text-lg text-sky-700 dark:text-sky-400 mb-10">Dive deeper into TCC characteristics and model performance metrics.</p>
            <div class="bg-white/60 dark:bg-slate-800/60 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-slate-700">
                <div class="flex justify-center border-b border-gray-300 dark:border-slate-600 mb-6">
                    <button data-tab="details" class="tab-button py-3 px-6 text-lg font-semibold transition">Details</button>
                    <button data-tab="temp-profile" class="tab-button py-3 px-6 text-lg font-semibold transition">Temp Profile</button>
                    <button data-tab="climate-explorer" class="tab-button py-3 px-6 text-lg font-semibold transition">Climate Explorer</button>
                    <button data-tab="training-metrics" class="tab-button py-3 px-6 text-lg font-semibold transition">Training Metrics</button>
                </div>
                <div id="tab-content-details" class="tab-content">
                    <h3 class="text-2xl font-bold text-sky-700 dark:text-sky-400 mb-4">Recent TCC Detections</h3>
                    <div id="cluster-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Cluster cards will be dynamically inserted here -->
                    </div>
                </div>
                <div id="tab-content-temp-profile" class="tab-content hidden relative h-96"><canvas id="tempProfileChart"></canvas></div>
                <div id="tab-content-climate-explorer" class="tab-content hidden">
                     <p class="text-center text-gray-700 dark:text-gray-300 mb-4">Adjust sliders to see the simulated impact on TCC activity.</p>
                    <div class="p-4 bg-blue-50 dark:bg-slate-700 rounded-lg shadow-inner max-w-lg mx-auto">
                        <div class="mb-4">
                            <label for="sst-slider" class="block text-sky-700 dark:text-sky-300 font-semibold mb-2">Sea Surface Temp (¬∞C): <span id="sst-value">28.0</span></label>
                            <input type="range" id="sst-slider" min="25" max="32" value="28" step="0.1" class="w-full">
                        </div>
                        <div class="mb-4">
                            <label for="wind-shear-slider" class="block text-sky-700 dark:text-sky-300 font-semibold mb-2">Vertical Wind Shear (m/s): <span id="wind-shear-value">10.0</span></label>
                            <input type="range" id="wind-shear-slider" min="5" max="20" value="10" step="0.5" class="w-full">
                        </div>
                        <p class="text-center text-lg font-bold mt-6">Simulated Activity Likelihood: <span id="tcc-likelihood" class="text-sky-800 dark:text-sky-300">Moderate</span></p>
                    </div>
                </div>
                <div id="tab-content-training-metrics" class="tab-content hidden relative h-96"><canvas id="trainingMetricsChart"></canvas></div>
            </div>
        </section>

        <!-- Section: Expected Outcomes -->
        <section id="outcomes">
            <h2 class="text-3xl font-bold text-center mb-2 text-sky-800 dark:text-sky-300">Sample TCC Outcomes</h2>
            <p class="text-center text-lg text-sky-700 dark:text-sky-400 mb-10">A sample visualization of a single identified cluster, updated periodically.</p>
            <div class="bg-white/60 dark:bg-slate-800/60 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-slate-700">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center" id="outcome-cards">
                    <!-- Data cards will be populated by JS -->
                </div>
                <div class="relative h-96 w-full max-w-xl mx-auto mt-8">
                     <canvas id="outcomesRadarChart"></canvas>
                </div>
            </div>
        </section>
        
        <!-- Section: LLM Q&A -->
        <section id="llm-qa">
            <h2 class="text-3xl font-bold text-center mb-2 text-sky-800 dark:text-sky-300">‚ú® AI Algorithm Q&A ‚ú®</h2>
            <p class="text-center text-lg text-sky-700 dark:text-sky-400 mb-6">Ask our AI assistant about the TCC identification algorithm.</p>
            <div class="bg-white/60 dark:bg-slate-800/60 p-6 rounded-xl shadow-lg border border-blue-200 dark:border-slate-700 max-w-2xl mx-auto">
                <textarea id="qaInput" class="w-full p-3 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-900 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500 mb-4" rows="3" placeholder="e.g., How is TCC independence determined?"></textarea>
                <button id="askAiBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105 duration-300 flex items-center justify-center mx-auto">Ask AI</button>
                <div id="qaLoadingSpinner" class="hidden flex justify-center items-center py-4 mt-4">
                    <div class="spinner h-6 w-6 border-2 border-t-sky-500 border-gray-200 dark:border-gray-600 dark:border-t-sky-500 rounded-full"></div>
                    <span class="ml-3 text-sky-600 dark:text-sky-400 font-medium">AI is thinking...</span>
                </div>
                <div id="qaOutput" class="bg-white dark:bg-slate-900/50 p-4 rounded-lg shadow-inner border border-gray-200 dark:border-slate-700 min-h-[100px] text-gray-700 dark:text-gray-300 mt-6 whitespace-pre-wrap">Your AI answers will appear here.</div>
            </div>
        </section>

    </main>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- GLOBAL STATE & ELEMENTS ---
        const state = {
            theme: 'light',
            charts: {},
            globe: {},
            apiKey: '', // IMPORTANT: Add your Gemini API key here for the Q&A feature to work.
            currentClusters: []
        };

        const elements = {
            // Overlays & Modals
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingMessage: document.getElementById('loadingMessage'),
            confirmationModal: document.getElementById('confirmationModal'),
            modalMessage: document.getElementById('modalMessage'),
            modalConfirmBtn: document.getElementById('modalConfirmBtn'),
            modalCancelBtn: document.getElementById('modalCancelBtn'),
            // Theme Toggle
            themeToggle: document.getElementById('theme-toggle'),
            lightIcon: document.getElementById('theme-toggle-light-icon'),
            darkIcon: document.getElementById('theme-toggle-dark-icon'),
            // Methodology Section
            stepButtons: document.querySelectorAll('.step-card'),
            stepContentContainer: document.getElementById('step-content-container'),
            // Globe Section
            globeCanvas: document.getElementById('globeCanvas'),
            resetGlobeBtn: document.getElementById('resetGlobeBtn'),
            latDisplay: document.getElementById('current-latitude'),
            lonDisplay: document.getElementById('current-longitude'),
            modeButtons: document.querySelectorAll('.globe-mode-btn'),
            clearDataBtn: document.getElementById('clearDataBtn'),
            lastUpdated: document.getElementById('last-updated'),
            // Dashboard Section
            tabButtons: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),
            clusterList: document.getElementById('cluster-list'),
            sstSlider: document.getElementById('sst-slider'),
            sstValue: document.getElementById('sst-value'),
            windShearSlider: document.getElementById('wind-shear-slider'),
            windShearValue: document.getElementById('wind-shear-value'),
            tccLikelihood: document.getElementById('tcc-likelihood'),
            // Outcomes Section
            outcomeCardsContainer: document.getElementById('outcome-cards'),
            // AI Q&A Section
            qaInput: document.getElementById('qaInput'),
            askAiBtn: document.getElementById('askAiBtn'),
            qaOutput: document.getElementById('qaOutput'),
            qaSpinner: document.getElementById('qaLoadingSpinner'),
        };

        // --- INITIALIZATION ---
        function main() {
            showLoading("Initializing Application...");
            initTheme();
            initNavigation();
            initUIComponents();
            initGlobe();
            
            document.addEventListener('firebaseReady', () => {
                showLoading("Loading initial data...");
                // Simulate async data loading
                setTimeout(() => {
                    updateAllData();
                    setInterval(updateAllData, 1800000); // Update every 30 mins
                    hideLoading();
                }, 500);
            });
             // Add a small delay for the adaptive quality check to not interfere with initial load
            setTimeout(adaptGlobeQuality, 2000);
        }

        // --- THEME MANAGEMENT ---
        function initTheme() {
            // Set initial theme based on localStorage or system preference
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            updateTheme(initialTheme);

            // Add event listener for the toggle button
            elements.themeToggle.addEventListener('click', () => {
                const newTheme = state.theme === 'light' ? 'dark' : 'light';
                updateTheme(newTheme);
            });
        }
        
        function updateTheme(theme) {
            state.theme = theme;
            localStorage.setItem('theme', theme);
            
            // Toggle class on the root element
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                elements.lightIcon.classList.add('hidden');
                elements.darkIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                elements.lightIcon.classList.remove('hidden');
                elements.darkIcon.classList.add('hidden');
            }

            // Always update components that depend on the theme
            updateAllChartColors();
            if(state.globe.renderer) {
                state.globe.renderer.setClearColor(theme === 'dark' ? 0x0f172a : 0xf0f9ff, 1);
            }
        }

        // --- UI & NAVIGATION ---
        function initNavigation() {
            const mobileNav = document.getElementById('mobile-nav');
            mobileNav.addEventListener('change', (e) => {
                const target = document.querySelector(e.target.value);
                if(target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }

        function initUIComponents() {
            // Methodology Section
            elements.stepButtons.forEach(btn => btn.addEventListener('click', () => updateMethodologyStep(btn.dataset.step)));
            updateMethodologyStep('1'); // Set initial state

            // Dashboard Section
            elements.tabButtons.forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab)));
            showTab('details'); // Set initial state
            
            // Climate Explorer Sliders
            elements.sstSlider.addEventListener('input', updateClimateExplorer);
            elements.windShearSlider.addEventListener('input', updateClimateExplorer);
            updateClimateExplorer();
        }

        // --- CORE FUNCTIONALITY ---
        
        // General Loading & Modal
        function showLoading(message = "Loading...") {
            elements.loadingMessage.textContent = message;
            elements.loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
        }
        function hideLoading() {
            elements.loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
        }
        
        // Data Update Cycle
        function updateAllData() {
            showLoading("Updating analysis data...");
            state.currentClusters = generateSimulatedClusters(Math.floor(Math.random() * 5) + 4);
            
            updateDashboard();
            updateOutcomes();
            updateGlobeTexture();

            elements.lastUpdated.textContent = new Date().toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata' });
            hideLoading();
        }

        // Methodology Section Logic
        function updateMethodologyStep(step) {
            const stepsData = {
                '1': { title: '1. Data Ingestion', content: `<p>The process begins by loading half-hourly INSAT-3D Infrared Brightness Temperature (IRBRT) data, which is then georeferenced to map pixels to real-world coordinates.</p><ul class="list-disc list-inside mt-2 space-y-1 text-sm"><li><strong>Source:</strong> INSAT-3D Satellite</li><li><strong>Frequency:</strong> Every 30 minutes</li></ul>` },
                '2': { title: '2. Candidate Identification', content: `<p>TCC candidates are identified by filtering the satellite scene for cold and large cloud areas that meet specific criteria.</p><ul class="list-disc list-inside mt-2 space-y-1 text-sm"><li><strong>Minimum Radius:</strong> 1¬∞ latitude (~111 km)</li><li><strong>Minimum Area:</strong> 34,800 km¬≤</li></ul>` },
                '3': { title: '3. Independence Check', content: `<p>The algorithm determines if nearby convective areas are independent TCCs or part of a larger parent system based on proximity.</p><ul class="list-disc list-inside mt-2 space-y-1 text-sm"><li><strong>Proximity Rule:</strong> Candidates within 1200 km of a larger cluster are grouped.</li></ul>` },
                '4': { title: '4. TCC Tracking', content: `<p>Once a TCC is identified, its movement is tracked by searching for it in previous satellite images within an expanding search radius.</p><div class="relative h-64 mt-4"><canvas id="trackingChart"></canvas></div>` }
            };
            
            elements.stepButtons.forEach(btn => {
                const isActive = btn.dataset.step === step;
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('border-orange-400', isActive);
                btn.classList.toggle('dark:border-orange-500', isActive);
                btn.classList.toggle('border-transparent', !isActive);
            });

            elements.stepContentContainer.innerHTML = `
                <h3 class="text-2xl font-bold text-sky-800 dark:text-sky-300 mb-4">${stepsData[step].title}</h3>
                <div class="text-gray-700 dark:text-gray-300">${stepsData[step].content}</div>
            `;
            if (step === '4') renderTrackingChart();
        }

        // Dashboard Section Logic
        function showTab(tabId) {
            elements.tabContents.forEach(content => content.classList.add('hidden'));
            elements.tabButtons.forEach(button => {
                const isActive = button.dataset.tab === tabId;
                button.classList.toggle('active', isActive);
                button.classList.toggle('text-orange-500', isActive);
                button.classList.toggle('dark:text-orange-400', isActive);
                button.classList.toggle('border-orange-500', isActive);
                button.classList.toggle('dark:border-orange-400', isActive);
                button.classList.toggle('text-gray-600', !isActive);
                button.classList.toggle('dark:text-gray-400', !isActive);
                button.classList.toggle('border-transparent', !isActive);
            });
            document.getElementById(`tab-content-${tabId}`).classList.remove('hidden');

            // Re-render charts when their tab becomes visible to ensure correct sizing
            if (tabId === 'temp-profile') renderTempProfileChart();
            else if (tabId === 'training-metrics') renderTrainingMetricsChart();
        }

        function updateDashboard() {
            if (state.currentClusters.length === 0) {
                elements.clusterList.innerHTML = `<p class="text-center col-span-full">No TCCs identified in the latest simulation.</p>`;
                return;
            }
            elements.clusterList.innerHTML = state.currentClusters.map(cluster => {
                 const statusColor = { 'Active': 'text-green-500', 'Developing': 'text-yellow-500', 'Dissipated': 'text-red-500' }[cluster.status];
                return `
                <div class="bg-sky-50 dark:bg-slate-700/50 p-4 rounded-lg shadow-sm border border-sky-100 dark:border-slate-700">
                    <h4 class="font-bold text-sky-700 dark:text-sky-400 text-lg">${cluster.id}</h4>
                    <p class="text-sm">Lat/Lon: ${cluster.lat}¬∞ / ${cluster.lon}¬∞</p>
                    <p class="text-sm">Area: ${cluster.size.toLocaleString()} km¬≤</p>
                    <p class="text-sm font-semibold ${statusColor}">${cluster.status}</p>
                </div>`;
            }).join('');
        }

        function updateClimateExplorer() {
            const sst = parseFloat(elements.sstSlider.value);
            const windShear = parseFloat(elements.windShearSlider.value);
            elements.sstValue.textContent = sst.toFixed(1);
            elements.windShearValue.textContent = windShear.toFixed(1);

            let score = 0;
            if (sst >= 27.5) score += 2;
            else if (sst >= 26.5) score += 1;
            if (windShear <= 8) score += 2;
            else if (windShear <= 12) score += 1;
            
            const likelihoodText = score >= 4 ? 'High' : (score >= 2 ? 'Moderate' : 'Low');
            elements.tccLikelihood.textContent = likelihoodText;
        }

        // Outcomes Section Logic
        function updateOutcomes() {
            const sample = state.currentClusters[0] || {};
            const outcomes = {
                "Mean Temp": `${sample.meanTemp || 'N/A'} K`,
                "Min Temp": `${sample.minTemp || 'N/A'} K`,
                "Mean Radius": `${sample.meanRadius ? sample.meanRadius.toLocaleString() : 'N/A'} km`,
                "Cloud Height": `${sample.cloudHeight || 'N/A'} km`,
            };
            elements.outcomeCardsContainer.innerHTML = Object.entries(outcomes).map(([key, value]) => `
                <div class="bg-sky-100 dark:bg-slate-700 p-4 rounded-lg">
                    <p class="text-sm text-sky-600 dark:text-sky-400 font-medium">${key}</p>
                    <p class="text-2xl font-bold">${value}</p>
                </div>
            `).join('');

            const normalizedData = [
                ((sample.meanTemp || 220) - 210) / 20,
                ((sample.minTemp || 190) - 180) / 30,
                ((sample.meanRadius || 150) - 50) / 200,
                ((sample.cloudHeight || 14) - 10) / 10
            ].map(v => Math.max(0, Math.min(1, v)));
            renderOutcomesRadarChart(normalizedData);
        }

        // AI Q&A Logic
        elements.askAiBtn.addEventListener('click', async () => {
            const question = elements.qaInput.value.trim();
            if (!question) {
                elements.qaOutput.textContent = "Please enter a question.";
                return;
            }
            if (!state.apiKey) {
                elements.qaOutput.textContent = "API Key is not configured. Please add your Gemini API key in the script to enable this feature.";
                return;
            }
            elements.qaSpinner.classList.remove('hidden');
            elements.qaOutput.textContent = '';
            elements.askAiBtn.disabled = true;

            try {
                const prompt = `You are an expert on meteorology and satellite data analysis. Based on a scientific model for identifying Tropical Cloud Clusters (TCCs), answer this question concisely: "${question}". Key model details: it uses half-hourly INSAT-3D infrared data, identifies candidates by cold temperatures and large size (>34,800 km¬≤), checks for independence (clusters >1200km apart are distinct), and tracks their movement over time.`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API Error: ${response.statusText}`);
                }
                const result = await response.json();
                elements.qaOutput.textContent = result.candidates[0].content.parts[0].text;
            } catch (error) {
                elements.qaOutput.textContent = `An error occurred: ${error.message}`;
            } finally {
                elements.qaSpinner.classList.add('hidden');
                elements.askAiBtn.disabled = false;
            }
        });
        
        // --- CHART RENDERING ---
        function renderChart(canvasId, config) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (state.charts[canvasId]) state.charts[canvasId].destroy();
            state.charts[canvasId] = new Chart(ctx, config);
        }

        function getChartOptions() {
            const isDark = state.theme === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const fontColor = isDark ? '#e2e8f0' : '#0c4a6e';
            return {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: fontColor } }, title: { color: fontColor, font: { size: 16 } } },
                scales: { 
                    x: { ticks: { color: fontColor }, grid: { color: gridColor } },
                    y: { ticks: { color: fontColor }, grid: { color: gridColor } }
                }
            };
        }

        function updateAllChartColors() {
            const options = getChartOptions();
            const isDark = state.theme === 'dark';
            Chart.defaults.color = options.plugins.legend.labels.color;
            for(const chartId in state.charts) {
                const chart = state.charts[chartId];
                if(chart) {
                    chart.options.plugins.legend.labels.color = options.plugins.legend.labels.color;
                    chart.options.plugins.title.color = options.plugins.title.color;
                    chart.options.scales.x.ticks.color = options.scales.x.ticks.color;
                    chart.options.scales.x.grid.color = options.scales.x.grid.color;
                    chart.options.scales.y.ticks.color = options.scales.y.ticks.color;
                    chart.options.scales.y.grid.color = options.scales.y.grid.color;
                    if (chart.options.scales.r) { // Special case for radar chart
                        chart.options.scales.r.angleLines.color = options.scales.x.grid.color;
                        chart.options.scales.r.grid.color = options.scales.x.grid.color;
                        chart.options.scales.r.pointLabels.color = options.scales.x.ticks.color;
                        chart.options.scales.r.ticks.backdropColor = isDark ? '#1e293b' : '#f0f9ff';
                    }
                    chart.update();
                }
            }
        }
        
        function renderTrackingChart() {
            renderChart('trackingChart', {
                type: 'bar',
                data: {
                    labels: ['3 hrs', '6 hrs', '9 hrs', '12 hrs'],
                    datasets: [{ label: 'Search Radius (km)', data: [450, 550, 600, 650], backgroundColor: '#38bdf8' }]
                },
                options: { ...getChartOptions(), plugins: { legend: { display: false }, title: { display: true, text: 'Tracking Search Radius vs. Time' }}}
            });
        }
        
        function renderTempProfileChart() {
            renderChart('tempProfileChart', {
                type: 'line',
                data: {
                    labels: [0, 2, 4, 6, 8, 10, 12, 14, 16].map(a => `${a} km`),
                    datasets: [{ label: 'Temperature (K)', data: [295, 280, 265, 250, 235, 220, 210, 200, 195], borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.2)', fill: true }]
                },
                options: { ...getChartOptions(), plugins: { legend: { display: false }, title: { display: true, text: 'Simulated TCC Vertical Temperature Profile' }}}
            });
        }
        
        function renderTrainingMetricsChart() {
            renderChart('trainingMetricsChart', {
                type: 'line',
                data: {
                    labels: ['Epoch 1', 'Epoch 2', 'Epoch 3', 'Epoch 4', 'Epoch 5'],
                    datasets: [
                        { label: 'Accuracy (%)', data: [75, 82, 88, 91, 94], borderColor: '#10b981' },
                        { label: 'Loss', data: [0.8, 0.6, 0.4, 0.25, 0.15], borderColor: '#ef4444' }
                    ]
                },
                options: { ...getChartOptions(), plugins: { title: { display: true, text: 'Simulated AI Model Training Performance' }}}
            });
        }

        function renderOutcomesRadarChart(data) {
             const options = getChartOptions();
             options.scales.r = { 
                angleLines: { color: options.scales.x.grid.color },
                grid: { color: options.scales.x.grid.color },
                pointLabels: { color: options.scales.x.ticks.color, font: { size: 14 } },
                ticks: { backdropColor: state.theme === 'dark' ? '#1e293b' : '#f0f9ff', color: options.scales.x.ticks.color }
             };
            renderChart('outcomesRadarChart', {
                type: 'radar',
                data: {
                    labels: ['Mean Temp', 'Min Temp', 'Mean Radius', 'Cloud Height'],
                    datasets: [{
                        label: 'Normalized TCC Profile',
                        data: data,
                        backgroundColor: 'rgba(56, 189, 248, 0.2)',
                        borderColor: '#0ea5e9',
                        pointBackgroundColor: '#0ea5e9',
                        pointBorderColor: '#fff'
                    }]
                },
                options: options
            });
        }

        // --- 3D GLOBE ---
        function drawLandmasses(ctx, landColor) {
            ctx.fillStyle = landColor;
            const w = ctx.canvas.width;
            const h = ctx.canvas.height;

            // North America
            ctx.beginPath();
            ctx.moveTo(w * 0.08, h * 0.2);
            ctx.bezierCurveTo(w * 0.25, h * 0.05, w * 0.35, h * 0.15, w * 0.3, h * 0.35);
            ctx.bezierCurveTo(w * 0.25, h * 0.45, w * 0.15, h * 0.4, w * 0.05, h * 0.3);
            ctx.closePath();
            ctx.fill();

            // South America
            ctx.beginPath();
            ctx.moveTo(w * 0.23, h * 0.48);
            ctx.bezierCurveTo(w * 0.33, h * 0.4, w * 0.35, h * 0.6, w * 0.28, h * 0.8);
            ctx.bezierCurveTo(w * 0.2, h * 0.7, w * 0.18, h * 0.55, w * 0.23, h * 0.48);
            ctx.closePath();
            ctx.fill();

            // Africa
            ctx.beginPath();
            ctx.moveTo(w * 0.48, h * 0.3);
            ctx.bezierCurveTo(w * 0.58, h * 0.15, w * 0.68, h * 0.2, w * 0.66, h * 0.4);
            ctx.bezierCurveTo(w * 0.6, h * 0.65, w * 0.5, h * 0.7, w * 0.45, h * 0.55);
            ctx.bezierCurveTo(w * 0.46, h * 0.35, w * 0.48, h * 0.3, w * 0.48, h * 0.3);
            ctx.closePath();
            ctx.fill();

            // Europe & Asia
            ctx.beginPath();
            ctx.moveTo(w * 0.6, h * 0.1);
            ctx.bezierCurveTo(w * 0.95, h * 0.05, w * 0.9, h * 0.4, w * 0.75, h * 0.5);
            ctx.lineTo(w * 0.65, h * 0.4);
            ctx.bezierCurveTo(w * 0.7, h * 0.15, w * 0.6, h * 0.1, w * 0.6, h * 0.1);
            ctx.closePath();
            ctx.fill();

            // Australia
            ctx.beginPath();
            ctx.ellipse(w * 0.85, h * 0.75, 80, 50, Math.PI / 6, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fill();
        }

        function initGlobe() {
            const container = elements.globeCanvas.parentElement;
            state.globe.scene = new THREE.Scene();
            state.globe.camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            state.globe.renderer = new THREE.WebGLRenderer({ canvas: elements.globeCanvas, antialias: true, alpha: true });
            state.globe.renderer.setSize(container.clientWidth, container.clientHeight);
            state.globe.renderer.setClearColor(state.theme === 'dark' ? 0x0f172a : 0xf0f9ff, 1);

            // OPTIMIZATION: Start with a low-polygon sphere for fast initial load
            const lowPolyGeometry = new THREE.SphereGeometry(5, 16, 16);
            const material = new THREE.MeshPhongMaterial({ shininess: 30 });
            state.globe.earthMesh = new THREE.Mesh(lowPolyGeometry, material);
            state.globe.scene.add(state.globe.earthMesh);
            
            // NOTE: If you have a glTF model, you would load it here using THREE.GLTFLoader
            // and replace the `state.globe.earthMesh` with your loaded model.

            state.globe.scene.add(new THREE.AmbientLight(0xcccccc, 0.8));
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
            dirLight.position.set(5, 3, 5);
            state.globe.scene.add(dirLight);

            state.globe.camera.position.z = 12;
            
            let isDragging = false, previousMousePos = { x: 0, y: 0 };
            const startDrag = (x, y) => { isDragging = true; previousMousePos = { x, y }; };
            const endDrag = () => { isDragging = false; };
            const drag = (x, y) => {
                if (!isDragging) return;
                const delta = { x: x - previousMousePos.x, y: y - previousMousePos.y };
                state.globe.earthMesh.rotation.y += delta.x * 0.005;
                state.globe.earthMesh.rotation.x += delta.y * 0.005;
                previousMousePos = { x, y };
                updateLatLonDisplay();
            };

            elements.globeCanvas.addEventListener('mousedown', (e) => startDrag(e.clientX, e.clientY));
            elements.globeCanvas.addEventListener('mouseup', endDrag);
            elements.globeCanvas.addEventListener('mouseleave', endDrag);
            elements.globeCanvas.addEventListener('mousemove', (e) => drag(e.clientX, e.clientY));
            elements.globeCanvas.addEventListener('touchstart', (e) => startDrag(e.touches[0].clientX, e.touches[0].clientY), { passive: true });
            elements.globeCanvas.addEventListener('touchend', endDrag);
            elements.globeCanvas.addEventListener('touchmove', (e) => drag(e.touches[0].clientX, e.touches[0].clientY), { passive: true });
            
            elements.globeCanvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                state.globe.camera.position.z = Math.max(7, Math.min(20, state.globe.camera.position.z + e.deltaY * 0.01));
            }, { passive: false });
            
            elements.resetGlobeBtn.addEventListener('click', () => {
                state.globe.earthMesh.rotation.set(0, 0, 0);
                state.globe.camera.position.z = 12;
                updateLatLonDisplay();
            });
            
            elements.modeButtons.forEach(btn => btn.addEventListener('click', () => {
                elements.modeButtons.forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white', 'dark:bg-blue-500');
                    b.classList.add('bg-gray-200', 'dark:bg-slate-700', 'text-gray-800', 'dark:text-gray-300');
                });
                btn.classList.add('bg-blue-500', 'text-white', 'dark:bg-blue-500');
                btn.classList.remove('bg-gray-200', 'dark:bg-slate-700', 'text-gray-800', 'dark:text-gray-300');
                state.globe.currentMode = btn.dataset.mode;
                updateGlobeTexture();
            }));
            document.querySelector('.globe-mode-btn[data-mode="visible"]').click();

            window.addEventListener('resize', () => {
                state.globe.camera.aspect = container.clientWidth / container.clientHeight;
                state.globe.camera.updateProjectionMatrix();
                state.globe.renderer.setSize(container.clientWidth, container.clientHeight);
            });
            
            (function animate() {
                requestAnimationFrame(animate);
                if (!isDragging) {
                    state.globe.earthMesh.rotation.y += 0.0005;
                }
                state.globe.renderer.render(state.globe.scene, state.globe.camera);
            })();
            updateLatLonDisplay();
        }

        // OPTIMIZATION: Function to upgrade globe quality on capable devices
        function adaptGlobeQuality() {
            // Use navigator.hardwareConcurrency to estimate device power. 4+ cores is a decent heuristic for a desktop/powerful device.
            if (navigator.hardwareConcurrency && navigator.hardwareConcurrency >= 4) {
                console.log("Upgrading globe to high quality.");
                const highPolyGeometry = new THREE.SphereGeometry(5, 64, 64);
                state.globe.earthMesh.geometry.dispose(); // Free memory from the old geometry
                state.globe.earthMesh.geometry = highPolyGeometry;
            } else {
                console.log("Keeping low quality globe for performance.");
            }
        }

        function updateGlobeTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 2048; canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            const mode = state.globe.currentMode || 'visible';
            
            // Base layer (ocean)
            ctx.fillStyle = mode === 'infrared' ? '#333' : (mode === 'water-vapor' ? '#003366' : '#1e90ff');
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Landmasses
            const landColor = mode === 'infrared' ? '#555' : (mode === 'water-vapor' ? '#336699' : '#228B22');
            drawLandmasses(ctx, landColor);
            
            // Clouds - Made slightly more transparent to see landmasses
            for(let i = 0; i < 80; i++) {
                const alpha = (mode === 'cloud-clusters' ? 0.5 : 0.25) + Math.random() * 0.3;
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 20 + Math.random() * 50, 0, Math.PI * 2);
                ctx.fill();
            }

            if(state.globe.earthMesh.material.map) state.globe.earthMesh.material.map.dispose();
            state.globe.earthMesh.material.map = new THREE.CanvasTexture(canvas);
            state.globe.earthMesh.material.needsUpdate = true;
        }

        function updateLatLonDisplay() {
            let lat = (state.globe.earthMesh.rotation.x * 180 / Math.PI) % 180;
            if (lat > 90) lat = 180 - lat; if (lat < -90) lat = -180 - lat;
            let lon = (state.globe.earthMesh.rotation.y * 180 / Math.PI) % 360;
            if (lon > 180) lon -= 360; if (lon < -180) lon += 360;
            elements.latDisplay.textContent = (-lat).toFixed(2);
            elements.lonDisplay.textContent = (-lon).toFixed(2);
        }

        // --- DATA SIMULATION ---
        function generateSimulatedClusters(count) {
            return Array.from({ length: count }, () => ({
                id: `TCC-${Math.floor(1000 + Math.random() * 9000)}`,
                lat: (Math.random() * 60 - 30).toFixed(2),
                lon: (Math.random() * 360 - 180).toFixed(2),
                size: Math.floor(35000 + Math.random() * 100000),
                minTemp: parseFloat((185 + Math.random() * 15).toFixed(1)),
                meanTemp: parseFloat((210 + Math.random() * 15).toFixed(1)),
                meanRadius: Math.floor(100 + Math.random() * 100),
                cloudHeight: parseFloat((12 + Math.random() * 4).toFixed(1)),
                status: ['Active', 'Developing', 'Dissipated'][Math.floor(Math.random() * 3)],
            }));
        }

        // --- RUN APP ---
        main();
    });
    </script>
</body>
</html>
